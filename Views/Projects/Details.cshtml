@model BugTracker.Models.Project
@using BugTracker.Extensions
@using BugTracker.Models.Enums
@using BugTracker.Services.Interfaces
@using Microsoft.AspNetCore.Identity

@inject UserManager<BTUser> UserManager
@inject IBTProjectService ProjectService
@inject IBTTicketHistoryService HistoryService
@inject IBTTicketService TicketService
@{
    ViewData["Title"] = "Details";

    BTUser user = await UserManager.GetUserAsync(User);
    BTUser projectManager = await ProjectService.GetProjectManagerAsync(Model.Id);

    int companyId = User.Identity.GetCompanyId().Value;
}

<div class="app-wrapper">
    <div class="app-content pt-3 p-md-3 p-lg-4">
	    <div class="container-xl">
            <h2>Project Details</h2>
            <br />
            <div class="row g-5">
                <div class="col-4">
                     @*Top Card*@
                    <div class="row mb-4">
                        <div class="col-12 app-card h-100 text-start p-3 rounded-5">
                            <div class="card-body">
                                <h3>@Model.Name</h3>
                                <p>@Model.Description</p>
                                @* Razor code block *@
						        @{
							        var start = Model.StartDate.DateTime;
							        var end = Model.EndDate.DateTime;
							        var today = DateTime.Now;
							        var percent = today >= end ? 100 : today < start ? 0 : Math.Round((today.Subtract(start)) / (end.Subtract(start)) * 100);
						        }
                                <span>Project Status</span>
                                <div class="progress-bar progress-bar-striped bg-primary" role="progressbar" aria-valuenow="60" aria-valuemin="0" aria-valuemax="100" style="width: @percent%;">
								    @* Use Progress Bar code variable here *@
                                    
								    <span class="progress-value">@percent%</span>
							    </div>
                            </div>
                        </div>
                    </div>
                    @*Middle Card*@
                    <div class="row mb-4">
                        <div class="col-12 app-card h-100">
                            <div class="card-body">
                                @*Created*@
                                <div class="row">
                                    <div class="col-6 text-start">
                                        <p class="text-muted">Created:</p>
                                    </div>
                                    <div class="col-6 text-end">@Model.StartDate.ToString("MMM dd, yyyy")</div>
                                </div>
                                @*Deadline*@
                                <div class="row">
                                    <div class="col-6 text-start">
                                        <p class="text-muted">Deadline:</p>
                                    </div>
                                    <div class="col-6 text-end">@Model.EndDate.ToString("MMM dd, yyyy")</div>
                                </div>
                                @*Priority*@
                                <div class="row">
                                    <div class="col-6 text-start">
                                        <p class="text-muted">Priority:</p>
                                    </div>
                                    <div class="col-6 text-end">@Model.ProjectPriority.Name</div>
                                </div>
                                @*Status*@
                                <div class="row">
                                    <div class="col-6 text-start">
                                        <p class="text-muted">Status:</p>
                                    </div>
                                    @if(Model.StartDate <= DateTime.Now)
                                    {
                                        <div class="col-6 text-end">Active</div>
                                    }
                                    else
                                    {
                                        <div class="col-6 text-end">Inactive</div>
                                    }
                                </div>
                            </div>
                        </div>
                    </div>

                    @*Bottom Card*@
                    <div class="row">
                        <div class="col-12 app-card h-100">
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-12">
                                        <h4>Project Team</h4>
                                        <p class="text-muted">@Model.Members.Count team members</p>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-2">

                                    </div>
                                </div>
								@if (projectManager is not null)
								{
                                    <div class="row">
                                        <div class="col-2">
									    @if (projectManager.AvatarFileData is null)
									    {
										    <img class="rounded-circle shadow-sm" style="width:60px;height:60px;outline-color:white;outline-width:thin;" src="https://cdn.icon-icons.com/icons2/1378/PNG/512/avatardefault_92824.png" alt="Default Avatar"/>
									    }
									    else
									    {
										    <img class="rounded-circle shadow-sm btn-outline-light" style="width:60px;height:60px;outline-color:white;outline-width:thin;" src="data:image/*;base64,@(Convert.ToBase64String(projectManager.AvatarFileData))" alt="@projectManager.FullName's avatar'" />
									    }
                                        </div>
                                        <div class="col-10 text-start">
                                            <div class="row">
                                                <div class="col-12">
                                                    <span>@projectManager.FullName</span>
                                                </div>
                                            </div>
                                            <div class="row">
                                                <div class="col-12">
                                                    <span class="text-sm">@projectManager.Email</span>
                                                </div>
                                            </div>
                                            <div class="row">
                                                <div class="col-12">
                                                    <span class="text-muted">Project Manager</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
								}
								else
								{
									<span class="truncate">Not Assigned</span>
								}

                                <hr />
                               
                                    @foreach(BTUser member in Model.Members.Where(m => m.Id != projectManager.Id)) 
                                    {
                                        <div class="row mb-3">
                                            <div class="col-2">
                                                @if (member.AvatarFileData is null)
									            {
										            <img class="rounded-circle shadow-sm" style="width:45px;height:45px;outline-color:white;outline-width:thin;" src="https://cdn.icon-icons.com/icons2/1378/PNG/512/avatardefault_92824.png" alt="Default Avatar"/>
									            }
									            else
									            {
										            <img class="rounded-circle shadow-sm btn-outline-light" style="width:45px;height:45px;outline-color:white;outline-width:thin;" src="data:image/*;base64,@(Convert.ToBase64String(member.AvatarFileData))" alt="@member.FullName's avatar'" />
									            }
                                            </div>
                                            <div class="col-10 text-start">
                                                <div class="row">
                                                    <div class="col-12">
                                                        <span>@member.FullName</span>
                                                    </div>
                                                </div>
                                                <div class="row">
                                                    <div class="col-12">
                                                        <span>@member.Email</span>
                                                    </div>
                                                </div>
                                                <div class="row">
                                                    <div class="col-12">
                                                        <span class="text-muted">Developer</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    }
                                @if(User.IsInRole(nameof(Roles.Admin)) || User.IsInRole(nameof(Roles.ProjectManager)))
                                {
                                    <div class="row">
                                        <a asp-action="AssignMembers" asp-controller="Projects" asp-route-id="@Model.Id" class="btn btn-sm btn-primary text-white">Assign Members</a>
                                    </div>
                                }
                            </div>
                        </div>
                    </div>

                </div>
                <div class="col-8">
                    @if (Model.Tickets.Any())
					{
						<div class="tab-content" id="orders-table-tab-content">
							<div class="tab-pane fade show active" id="orders-cancelled" role="tabpanel" aria-labelledby="orders-cancelled-tab">
								<div class="app-card app-card-orders-table mb-4">
									<div class="app-card-body pt-3 ps-3 pe-3">
											<div class="table-responsive pb-3">
                                                <h4 class="mb-1">Tickets</h4>

												<table id="ticketsTable" class="table app-table-hover mb-0 text-left">
													<thead>
														<tr>
															<th class="cell">Title</th>
															<th class="cell">Developer</th>
															<th class="cell">Status</th>
															<th class="cell">Priority</th>
															<th class="cell">Date</th>
															<th class="cell">Action</th>
														</tr>
													</thead>
													<tbody>
														@foreach (Ticket ticket in Model.Tickets.Where(m => m.Archived == false))
														{

															<tr>
																<td class="cell">
																	<span>@ticket.Title</span>
																</td>
                                                                @{
                                                                    BTUser developerUser = await TicketService.GetTicketDeveloperAsync(ticket.Id, companyId);
                                                                }
                                                                @if(ticket.DeveloperUser is null && (User.IsInRole(nameof(Roles.Admin)) || User.IsInRole(nameof(Roles.ProjectManager)) ))
                                                                {
                                                                    <td>
                                                                        <a class="btn btn-sm btn-primary text-white" asp-action="AssignDeveloper" asp-controller="Tickets" asp-route-id="@ticket.Id">Assign Developer</a>
                                                                    </td>
                                                                }
                                                                else if(ticket.DeveloperUser is null && !(User.IsInRole(nameof(Roles.Admin)) || User.IsInRole(nameof(Roles.ProjectManager))))
                                                                {
                                                                    <td class="cell"><span class="truncate">Unassigned</span></td>
                                                                }
                                                                else
                                                                {
                                                                    <td class="cell"><span class="truncate">@developerUser.FullName</span></td>
                                                                }
																<td class="cell ">@ticket.TicketStatus.Name</td>
																<td class="cell">@ticket.TicketPriority.Name</td>
																<td class="cell">@ticket.Created.ToString("MM-dd-yyyy")</td>
																<td class="cell text-center">
																	<a class="btn-sm app-btn-secondary me-2" asp-action="Details" asp-controller="Projects" asp-route-id="@ticket.Id">
																		<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-eye-fill" viewBox="0 0 16 16">
																			<path d="M10.5 8a2.5 2.5 0 1 1-5 0 2.5 2.5 0 0 1 5 0z"/>
																			<path d="M0 8s3-5.5 8-5.5S16 8 16 8s-3 5.5-8 5.5S0 8 0 8zm8 3.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7z"/>
																		</svg>
																	</a>
																	@if (User.IsInRole(nameof(Roles.Admin)) || User.IsInRole(nameof(Roles.Admin)))
																	{
																		<a class="btn-sm app-btn-secondary me-2" asp-action="Edit" asp-controller="Tickets" asp-route-id="@ticket.Id">
																			<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-pencil-square" viewBox="0 0 16 16">
																				<path d="M15.502 1.94a.5.5 0 0 1 0 .706L14.459 3.69l-2-2L13.502.646a.5.5 0 0 1 .707 0l1.293 1.293zm-1.75 2.456-2-2L4.939 9.21a.5.5 0 0 0-.121.196l-.805 2.414a.25.25 0 0 0 .316.316l2.414-.805a.5.5 0 0 0 .196-.12l6.813-6.814z"/>
																				<path fill-rule="evenodd" d="M1 13.5A1.5 1.5 0 0 0 2.5 15h11a1.5 1.5 0 0 0 1.5-1.5v-6a.5.5 0 0 0-1 0v6a.5.5 0 0 1-.5.5h-11a.5.5 0 0 1-.5-.5v-11a.5.5 0 0 1 .5-.5H9a.5.5 0 0 0 0-1H2.5A1.5 1.5 0 0 0 1 2.5v11z"/>
																			</svg>
																		</a>
																		<a class="btn-sm app-btn-secondary g-2" asp-action="Archive" asp-controller="Tickets" asp-route-id="@ticket.Id">
														                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash" viewBox="0 0 16 16">
															                    <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/>
															                    <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/>
														                    </svg>
													                    </a>
																	}
																</td>
															</tr>
														}
													</tbody>
												</table>
											</div>
										
									</div>	
								</div>
							</div>
						</div>
					}
					else
					{
						<h3 class="text-muted text-center m-5">No Tickets Submitted</h3>
					}

                    <div class="tab-content" id="orders-table-tab-content">
						<div class="tab-pane fade show active" id="orders-cancelled" role="tabpanel" aria-labelledby="orders-cancelled-tab">
							<div class="app-card app-card-orders-table mb-5">
								<div class="app-card-body pt-2 ps-3 pe-3">
                                    <h3>Project Activity</h3>
                                    <hr />
                                    @*Develop This section*@
                                </div>
                            </div>
                        </div>
                    </div>
                    
                </div>
            </div>
        </div>
    </div>
</div>

@section scripts{ 

    <script>
        $(document).ready(function () {
            $("#ticketsTable").DataTable({
                "scrollY" : "450px",
                "scrollCollapse":true,
                "paging": true
            });
        });
    </script>

}